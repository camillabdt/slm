import json
import re

def parse_output(output_text):
    """Extrai os dados da questÃ£o, tratando formatos JSON e Texto Puro do SLM."""
    output_text = output_text.strip()
    
    # 1. Tentar parsear como JSON (Formato ideal)
    try:
        # Procura por algo que pareÃ§a um JSON dentro da string
        match = re.search(r'\{.*\}', output_text, re.DOTALL)
        if match:
            data = json.loads(match.group())
            return {
                "stem": data.get("stem", "QuestÃ£o sem enunciado"),
                "options": data.get("options", []),
                "correct": data.get("correctOption", "N/A"),
                "explanation": data.get("explanation", "Sem explicaÃ§Ã£o detalhada.")
            }
    except:
        pass

    # 2. Tentar extrair via Regex se for texto estruturado (Question: / Correct Answer:)
    stem_match = re.search(r'(?:Question|stem):\s*(.*?)(?=\n[0-9A-D]\)|$)', output_text, re.I | re.S)
    stem = stem_match.group(1).strip() if stem_match else "Enunciado no texto abaixo"
    
    options = re.findall(r'(?:[0-4A-D][\)\-\.])\s*(.*?)(?=\n|$)', output_text)
    
    correct_match = re.search(r'(?:Correct Answer|Ans|Correct):\s*(.*)', output_text, re.I)
    correct = correct_match.group(1).strip() if correct_match else "Ver explicaÃ§Ã£o"
    
    explanation_match = re.search(r'Explanation:\s*(.*)', output_text, re.I | re.S)
    explanation = explanation_match.group(1).strip() if explanation_match else output_text

    return {
        "stem": stem,
        "options": options if options else ["Ver texto original"],
        "correct": correct,
        "explanation": explanation
    }

def gerar_html():
    html_content = """
    <!DOCTYPE html>
    <html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Simulado BNCC - ComputaÃ§Ã£o 9Âº Ano</title>
        <style>
            body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
            .container { max-width: 850px; margin: auto; }
            header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
            .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 10px solid #007bff; }
            .meta { font-size: 0.85em; color: #666; text-transform: uppercase; margin-bottom: 10px; font-weight: bold; }
            .stem { font-size: 1.2em; font-weight: 600; margin-bottom: 20px; color: #1a1a1a; }
            .option { background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; margin: 8px 0; border-radius: 6px; }
            .btn-reveal { background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; }
            .btn-reveal:hover { background-color: #218838; }
            .answer-section { display: none; margin-top: 20px; padding: 15px; background-color: #fff3cd; border-radius: 8px; border-left: 5px solid #ffc107; }
            .explanation { margin-top: 10px; font-style: italic; color: #555; }
        </style>
        <script>
            function toggleAnswer(id) {
                var x = document.getElementById(id);
                x.style.display = (x.style.display === "block") ? "none" : "block";
            }
        </script>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>ðŸŽ“ Banco de QuestÃµes BNCC (9Âº Ano)</h1>
                <p>Gerado via SLM Training - Eixos: Pensamento Computacional, Mundo Digital e Cultura Digital</p>
            </header>
    """

    try:
        with open("banco_final_seguro.jsonl", "r", encoding="utf-8") as f:
            for i, line in enumerate(f):
                data = json.loads(line)
                q_info = parse_output(data['output'])
                
                # Ajusta cor conforme o pilar
                pilar = data.get('pilar', 'Geral')
                color = "#007bff" if "Pensamento" in pilar else "#fd7e14" if "Mundo" in pilar else "#28a745"

                html_content += f"""
                <div class="card" style="border-left-color: {color}">
                    <div class="meta">{pilar} | {data.get('subtema', '')} | TÃ©cnica: {data.get('tecnica', '')}</div>
                    <div class="stem">{i+1}. {q_info['stem']}</div>
                    <div class="options">
                """
                for opt in q_info['options']:
                    html_content += f'<div class="option">{opt}</div>'
                
                html_content += f"""
                    </div>
                    <button class="btn-reveal" onclick="toggleAnswer('ans{i}')">Ver Gabarito</button>
                    <div id="ans{i}" class="answer-section">
                        <strong>Gabarito:</strong> {q_info['correct']}<br>
                        <div class="explanation"><strong>ExplicaÃ§Ã£o:</strong> {q_info['explanation']}</div>
                    </div>
                </div>
                """
    except Exception as e:
        html_content += f"<p>Erro ao ler arquivo: {e}</p>"

    html_content += "</div></body></html>"
    
    with open("resultado_final.html", "w", encoding="utf-8") as f:
        f.write(html_content)
    print("âœ… Sucesso! Abra o arquivo 'resultado_final.html' no seu navegador.")

if __name__ == "__main__":
    gerar_html()